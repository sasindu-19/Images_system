<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hover-scale {
            transition: transform 0.3s ease;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }
        .image-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .glass:hover .image-actions {
            opacity: 1;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <!-- Navigation -->
    <nav class="glass p-4 mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Image Gallery</h1>
            <div id="nav-buttons" class="space-x-4">
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">Login</button>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors hidden">Logout</button>
                <span id="user-email" class="text-sm bg-green-600 px-3 py-1 rounded hidden"></span>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300">
                <input type="password" id="password" placeholder="Password" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300">
                <button id="login-submit" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg transition-colors">Login</button>
                <button id="close-modal" class="w-full bg-gray-600 hover:bg-gray-700 p-3 rounded-lg transition-colors">Cancel</button>
            </div>
            <div id="login-error" class="mt-4 text-red-400 text-sm hidden"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="container mx-auto px-4 mb-8 hidden">
        <div class="glass p-6 rounded-xl fade-in">
            <h2 class="text-2xl font-bold mb-6">Admin Panel - Upload Images</h2>
            
            <!-- Upload Form -->
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Select Image</label>
                    <input type="file" id="image-input" accept="image/*" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white file:bg-blue-600 file:text-white file:border-0 file:rounded file:px-4 file:py-2 file:mr-4">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Image Title</label>
                    <input type="text" id="image-title" placeholder="Enter image title" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Description</label>
                <textarea id="image-description" placeholder="Enter image description" rows="3" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300"></textarea>
            </div>
            
            <button id="upload-btn" class="mt-6 bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg transition-colors font-medium">
                Upload Image
            </button>
            
            <div id="upload-progress" class="mt-4 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm mt-2">Uploading...</p>
            </div>
        </div>
    </div>

    <!-- User Gallery -->
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8 text-center">Image Gallery</h2>
        
        <!-- Search and Filter -->
        <div class="mb-8">
            <div class="glass p-4 rounded-xl">
                <input type="text" id="search-input" placeholder="Search images..." class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300">
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            <p class="mt-2">Loading images...</p>
        </div>
        
        <!-- Images Grid -->
        <div id="images-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden">
            <!-- Images will be loaded here -->
        </div>
        
        <!-- No Images Message -->
        <div id="no-images" class="text-center py-12 hidden">
            <div class="glass p-8 rounded-xl">
                <h3 class="text-xl font-semibold mb-2">No Images Found</h3>
                <p class="text-gray-300">Images will appear here once uploaded by admin.</p>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center">
        <div class="max-w-4xl max-h-full m-4 relative">
            <button id="close-image-modal" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 rounded-full w-10 h-10 flex items-center justify-center z-10">
                âœ•
            </button>
            <img id="modal-image" class="max-w-full max-h-full rounded-lg">
            <div class="glass p-4 mt-4 rounded-lg">
                <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                <p id="modal-description" class="text-gray-300"></p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Edit Image</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Image Title</label>
                    <input type="text" id="edit-title" placeholder="Enter image title" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="edit-description" placeholder="Enter image description" rows="3" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button id="save-edit" class="flex-1 bg-green-600 hover:bg-green-700 p-3 rounded-lg transition-colors">Save Changes</button>
                    <button id="cancel-edit" class="flex-1 bg-gray-600 hover:bg-gray-700 p-3 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
            <div id="edit-error" class="mt-4 text-red-400 text-sm hidden"></div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-400">Delete Image</h2>
            <p class="text-center mb-6">Are you sure you want to delete this image? This action cannot be undone.</p>
            <div class="flex space-x-4">
                <button id="confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 p-3 rounded-lg transition-colors">Delete</button>
                <button id="cancel-delete" class="flex-1 bg-gray-600 hover:bg-gray-700 p-3 rounded-lg transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'djkngfvee',
            uploadPreset: 'my_upload_preset'
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFpd35irRGonKMj-kAjwpDUHqxlvmusiA",
            authDomain: "imagesystem-60097.firebaseapp.com",
            projectId: "imagesystem-60097",
            storageBucket: "imagesystem-60097.firebasestorage.app",
            messagingSenderId: "606655190964",
            appId: "1:606655190964:web:a693f3b58b99e1eee6c4e1",
            measurementId: "G-DKCYRFWJJY"
        };

        // Global variables
        let currentUser = null;
        let allImages = [];
        let db, auth;
        let currentEditingId = null;
        let currentDeletingId = null;

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Enable offline persistence
            db.enablePersistence().catch((err) => {
                console.log('Persistence error:', err);
            });
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase configuration error. Please check your config values.');
        }

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmail = document.getElementById('user-email');
        const loginModal = document.getElementById('login-modal');
        const adminPanel = document.getElementById('admin-panel');
        const imagesGrid = document.getElementById('images-grid');
        const loading = document.getElementById('loading');
        const noImages = document.getElementById('no-images');
        const searchInput = document.getElementById('search-input');
        const loginError = document.getElementById('login-error');
        const editModal = document.getElementById('edit-modal');
        const deleteModal = document.getElementById('delete-modal');

        // Event Listeners
        loginBtn.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            loginModal.classList.add('hidden');
            clearLoginForm();
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        document.getElementById('login-submit').addEventListener('click', handleLogin);
        document.getElementById('upload-btn').addEventListener('click', handleImageUpload);
        searchInput.addEventListener('input', handleSearch);

        // Image modal events
        document.getElementById('close-image-modal').addEventListener('click', () => {
            document.getElementById('image-modal').classList.add('hidden');
        });

        // Edit modal events
        document.getElementById('cancel-edit').addEventListener('click', () => {
            editModal.classList.add('hidden');
            currentEditingId = null;
        });

        document.getElementById('save-edit').addEventListener('click', handleSaveEdit);

        // Delete modal events
        document.getElementById('cancel-delete').addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            currentDeletingId = null;
        });

        document.getElementById('confirm-delete').addEventListener('click', handleConfirmDelete);

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                console.log('User signed in:', user.email);
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userEmail.classList.remove('hidden');
                userEmail.textContent = user.email;
                adminPanel.classList.remove('hidden');
                loginModal.classList.add('hidden');
                clearLoginForm();
            } else {
                console.log('User signed out');
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userEmail.classList.add('hidden');
                adminPanel.classList.add('hidden');
            }
            // Reload images to show/hide admin buttons
            loadImages();
        });

        function clearLoginForm() {
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            loginError.classList.add('hidden');
        }

        function showLoginError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showLoginError('Please enter email and password');
                return;
            }

            try {
                console.log('Attempting login with:', email);
                
                // Show loading state
                document.getElementById('login-submit').textContent = 'Logging in...';
                document.getElementById('login-submit').disabled = true;
                
                await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful');
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed: ';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'No user found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage += 'This account has been disabled.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many failed attempts. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showLoginError(errorMessage);
            } finally {
                // Reset button state
                document.getElementById('login-submit').textContent = 'Login';
                document.getElementById('login-submit').disabled = false;
            }
        }

        async function handleImageUpload() {
            const imageInput = document.getElementById('image-input');
            const title = document.getElementById('image-title').value.trim();
            const description = document.getElementById('image-description').value.trim();

            if (!imageInput.files[0]) {
                alert('Please select an image');
                return;
            }

            if (!title) {
                alert('Please enter image title');
                return;
            }

            if (!currentUser) {
                alert('Please login first');
                return;
            }

            const file = imageInput.files[0];
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please select an image under 10MB.');
                return;
            }

            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const uploadBtn = document.getElementById('upload-btn');

            uploadProgress.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            progressText.textContent = 'Uploading to Cloudinary...';

            try {
                console.log('Starting upload process...');
                console.log('Current user:', currentUser.email);

                // Upload to Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);

                console.log('Uploading to Cloudinary...');

                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Cloudinary upload failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Cloudinary response:', data);
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                progressBar.style.width = '50%';
                progressText.textContent = 'Saving to database...';

                // Wait for user to be fully authenticated
                await new Promise(resolve => {
                    if (currentUser) {
                        resolve();
                    } else {
                        const unsubscribe = auth.onAuthStateChanged(user => {
                            if (user) {
                                unsubscribe();
                                resolve();
                            }
                        });
                    }
                });

                console.log('Saving to Firebase...');

                // Create document data with current timestamp
                const imageData = {
                    title: title,
                    description: description || '',
                    url: data.secure_url,
                    publicId: data.public_id,
                    uploadedBy: currentUser.email,
                    uploadedAt: new Date(),
                    tags: title.toLowerCase().split(' ').filter(tag => tag.length > 0)
                };

                console.log('Image data to save:', imageData);

                // Add document to Firestore
                const docRef = await db.collection('images').add(imageData);
                console.log('Document written with ID:', docRef.id);

                progressBar.style.width = '100%';
                progressText.textContent = 'Upload complete!';

                // Reset form
                imageInput.value = '';
                document.getElementById('image-title').value = '';
                document.getElementById('image-description').value = '';

                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 2000);

                // Refresh images
                await loadImages();
                
            } catch (error) {
                console.error('Upload error:', error);
                
                let errorMessage = 'Upload failed: ';
                if (error.code) {
                    switch (error.code) {
                        case 'permission-denied':
                            errorMessage += 'Permission denied. Please check if you are logged in as admin.';
                            break;
                        case 'unavailable':
                            errorMessage += 'Database service unavailable. Please try again.';
                            break;
                        case 'invalid-argument':
                            errorMessage += 'Invalid data format.';
                            break;
                        case 'unauthenticated':
                            errorMessage += 'Authentication required. Please login again.';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Image';
            }
        }

        function openEditModal(imageId) {
            const image = allImages.find(img => img.id === imageId);
            if (!image) return;

            currentEditingId = imageId;
            document.getElementById('edit-title').value = image.title;
            document.getElementById('edit-description').value = image.description || '';
            editModal.classList.remove('hidden');
        }

        async function handleSaveEdit() {
            if (!currentEditingId || !currentUser) return;

            const title = document.getElementById('edit-title').value.trim();
            const description = document.getElementById('edit-description').value.trim();

            if (!title) {
                document.getElementById('edit-error').textContent = 'Please enter a title';
                document.getElementById('edit-error').classList.remove('hidden');
                return;
            }

            try {
                document.getElementById('save-edit').textContent = 'Saving...';
                document.getElementById('save-edit').disabled = true;

                await db.collection('images').doc(currentEditingId).update({
                    title: title,
                    description: description,
                    updatedAt: new Date(),
                    updatedBy: currentUser.email
                });

                editModal.classList.add('hidden');
                currentEditingId = null;
                await loadImages();

            } catch (error) {
                console.error('Edit error:', error);
                document.getElementById('edit-error').textContent = 'Failed to update image: ' + error.message;
                document.getElementById('edit-error').classList.remove('hidden');
            } finally {
                document.getElementById('save-edit').textContent = 'Save Changes';
                document.getElementById('save-edit').disabled = false;
            }
        }

        function openDeleteModal(imageId) {
            currentDeletingId = imageId;
            deleteModal.classList.remove('hidden');
        }

        async function handleConfirmDelete() {
            if (!currentDeletingId || !currentUser) return;

            const image = allImages.find(img => img.id === currentDeletingId);
            if (!image) return;

            try {
                document.getElementById('confirm-delete').textContent = 'Deleting...';
                document.getElementById('confirm-delete').disabled = true;

                // Delete from Cloudinary
                if (image.publicId) {
                    try {
                        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/destroy`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                public_id: image.publicId,
                                upload_preset: CLOUDINARY_CONFIG.uploadPreset
                            })
                        });
                        console.log('Cloudinary delete response:', await response.json());
                    } catch (cloudinaryError) {
                        console.warn('Cloudinary delete failed:', cloudinaryError);
                        // Continue with Firestore deletion even if Cloudinary fails
                    }
                }

                // Delete from Firestore
                await db.collection('images').doc(currentDeletingId).delete();

                deleteModal.classList.add('hidden');
                currentDeletingId = null;
                await loadImages();

            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete image: ' + error.message);
            } finally {
                document.getElementById('confirm-delete').textContent = 'Delete';
                document.getElementById('confirm-delete').disabled = false;
            }
        }

        async function loadImages() {
            loading.classList.remove('hidden');
            imagesGrid.classList.add('hidden');
            noImages.classList.add('hidden');

            try {
                console.log('Loading images from Firestore...');
                
                const snapshot = await db.collection('images')
                    .orderBy('uploadedAt', 'desc')
                    .get();
                
                allImages = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allImages.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log('Loaded images:', allImages.length);
                displayImages(allImages);
                
            } catch (error) {
                console.error('Error loading images:', error);
                loading.classList.add('hidden');
                
                if (error.code === 'permission-denied') {
                    // Try to load without ordering if permission denied
                    try {
                        const snapshot = await db.collection('images').get();
                        allImages = [];
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            allImages.push({
                                id: doc.id,
                                ...data
                            });
                        });
                        
                        // Sort client-side
                        allImages.sort((a, b) => {
                            const dateA = a.uploadedAt ? (a.uploadedAt.seconds || new Date(a.uploadedAt).getTime() / 1000) : 0;
                            const dateB = b.uploadedAt ? (b.uploadedAt.seconds || new Date(b.uploadedAt).getTime() / 1000) : 0;
                            return dateB - dateA;
                        });
                        
                        displayImages(allImages);
                    } catch (fallbackError) {
                        console.error('Fallback load also failed:', fallbackError);
                        noImages.classList.remove('hidden');
                    }
                } else {
                    noImages.classList.remove('hidden');
                }
            }
        }

        function displayImages(images) {
            loading.classList.add('hidden');
            
            if (images.length === 0) {
                noImages.classList.remove('hidden');
                imagesGrid.classList.add('hidden');
                return;
            }

            noImages.classList.add('hidden');
            imagesGrid.classList.remove('hidden');

            imagesGrid.innerHTML = images.map(image => {
                let uploadDate = 'Unknown';
                if (image.uploadedAt) {
                    try {
                        if (image.uploadedAt.seconds) {
                            // Firestore timestamp
                            uploadDate = new Date(image.uploadedAt.seconds * 1000).toLocaleDateString();
                        } else {
                            // Regular Date object
                            uploadDate = new Date(image.uploadedAt).toLocaleDateString();
                        }
                    } catch (e) {
                        console.log('Date parsing error:', e);
                    }
                }

                const adminButtons = currentUser ? `
                    <div class="image-actions flex space-x-1">
                        <button onclick="openEditModal('${image.id}')" class="bg-blue-600 hover:bg-blue-700 rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="openDeleteModal('${image.id}')" class="bg-red-600 hover:bg-red-700 rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                ` : '';

                return `
                    <div class="glass rounded-xl overflow-hidden hover-scale cursor-pointer fade-in relative">
                        ${adminButtons}
                        <img src="${image.url}" alt="${image.title}" class="w-full h-48 object-cover" loading="lazy" onclick="openImageModal('${image.id}')">
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-2">${image.title}</h3>
                            <p class="text-gray-300 text-sm line-clamp-2">${image.description || 'No description'}</p>
                            <div class="mt-2 text-xs text-gray-400">
                                Uploaded: ${uploadDate}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openImageModal(imageId) {
            const image = allImages.find(img => img.id === imageId);
            if (!image) return;

            document.getElementById('modal-image').src = image.url;
            document.getElementById('modal-title').textContent = image.title;
            document.getElementById('modal-description').textContent = image.description || 'No description';
            document.getElementById('image-modal').classList.remove('hidden');
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayImages(allImages);
                return;
            }

            const filteredImages = allImages.filter(image => 
                image.title.toLowerCase().includes(searchTerm) ||
                (image.description && image.description.toLowerCase().includes(searchTerm)) ||
                (image.tags && image.tags.some(tag => tag.includes(searchTerm)))
            );

            displayImages(filteredImages);
        }

        // Load images on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, loading images...');
            loadImages();
        });

        // Handle network errors
        window.addEventListener('online', () => {
            console.log('Network reconnected, reloading images...');
            loadImages();
        });

        window.addEventListener('offline', () => {
            console.log('Network disconnected');
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.classList.add('hidden');
                clearLoginForm();
            }
            if (e.target === editModal) {
                editModal.classList.add('hidden');
                currentEditingId = null;
            }
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
                currentDeletingId = null;
            }
            if (e.target === document.getElementById('image-modal')) {
                document.getElementById('image-modal').classList.add('hidden');
            }
        });

        // Handle escape key to close modals
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!loginModal.classList.contains('hidden')) {
                    loginModal.classList.add('hidden');
                    clearLoginForm();
                }
                if (!editModal.classList.contains('hidden')) {
                    editModal.classList.add('hidden');
                    currentEditingId = null;
                }
                if (!deleteModal.classList.contains('hidden')) {
                    deleteModal.classList.add('hidden');
                    currentDeletingId = null;
                }
                if (!document.getElementById('image-modal').classList.contains('hidden')) {
                    document.getElementById('image-modal').classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>